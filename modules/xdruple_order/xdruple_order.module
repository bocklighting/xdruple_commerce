<?php

include_once __DIR__ . '/pages/order.inc';

/**
 * Implements hook_views_api().
 */
function xdruple_order_views_api() {
  return [
    'api' => 3,
    'path' => drupal_get_path('module', 'xdruple_order') . '/includes/views',
  ];
}

/**
 * Implements hook_init()
 */
function xdruple_order_init() {
}

/**
 * Implements hook_menu()
 */
function xdruple_order_menu() {
  $items = [];

  $items['user/%user/pending-orders/%'] = [
    'title' => 'Order',
    'title callback' => 'xdruple_order_page_title',
    'title arguments' => [3],
    'page callback' => 'xdruple_order_page',
    'page arguments' => [3],
    'access arguments' => ['access content'],
    'file' => 'pages/order.inc',
  ];

  return $items;
}

/**
 * Implements hook_opencdd_body_classes_alter()
 *
 * @param $classes
 * @param $path
 */
function xdruple_order_opencdd_body_classes_alter(&$classes, $path) {
  if ($path == 'user/%/pending-orders/%') {
    $classes[] = 'page-user-pending-order';
  }
}

/**
 * Implements hook_menu_get_item_alter()
 *
 * @param $router_item
 */
function xdruple_order_menu_get_item_alter(&$router_item) {
  if ($router_item['path'] == 'user/%/pending-orders/%') {
    $router_item['tab_parent'] = 'user/%';
    $router_item['tab_root'] = 'user/%';
    $router_item['type'] = "132";
    $router_item['context'] = 1;
  }
}

/**
 * Implements hook_rescued_resources().
 */
function xdruple_order_rescued_resources() {
  return [
    "SalesOrder",
    "SalesOrderListItem",
    "RemitTo",
  ];
}

/**
 * Implements hook_views_pre_execute().
 *
 * @param $view
 */
function xdruple_order_views_pre_execute($view) {
  if ($view->name === 'xd_pending_orders') {
    // Query on Customer.
    /** @var Xtuple\Xdruple\Session\RescuedSession $session */
    global $session;
    if ($session->getRescued('customer')) {
      $view->query->query->propertyConditions[] = [
        'column' => 'customer',
        'value' => $session->getRescued('customer'),
        'operator' => '=',
      ];
      $view->build_info['count_query']->propertyConditions[] = [
        'column' => 'customer',
        'value' => $session->getRescued('customer'),
        'operator' => '=',
      ];
    }

    // Query on Ship To.
    if ($session->getRescued('ship_to')) {
      // Get the Ship To Name.
      $shipto_name = entity_load_single('xtuple_xdshipto', $session->getRescued('ship_to'));

      $view->query->query->propertyConditions[] = [
        'column' => 'shiptoName',
        'value' => $shipto_name->name,
        'operator' => '=',
      ];
      $view->build_info['count_query']->propertyConditions[] = [
        'column' => 'shiptoName',
        'value' => $shipto_name->name,
        'operator' => '=',
      ];
    }
  }
}

/**
 * Implements hook_theme()
 */
function xdruple_order_theme() {
  $items = [];

  $items['order_page'] = [
    'variables' => [
      'order' => [],
    ],
    'template' => 'theme/order-page',
    'file' => 'theme/theme.inc',
  ];

  return $items;
}
