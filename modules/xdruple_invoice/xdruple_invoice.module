<?php

include_once __DIR__ . '/pages/invoice.inc';

/**
 * Implements hook_views_api().
 */
function xdruple_invoice_views_api() {
  return array(
    'api'  => 3,
    'path' => drupal_get_path('module', 'xdruple_invoice') . '/includes/views',
  );
}

/**
 * Implements hook_init()
 */
function xdruple_invoice_init() {
}

/**
 * Implements hook_menu()
 */
function xdruple_invoice_menu() {
  $items = array();

  $items['user/%user/invoices/%'] = array(
    'title'            => 'Invoice',
    'title callback'   => 'xdruple_invoice_page_title',
    'title arguments'  => array(3),
    'page callback'    => 'xdruple_invoice_page',
    'page arguments'   => array(3),
    'access arguments' => array('access content'),
    'file'             => 'pages/invoice.inc',
  );

  return $items;
}

/**
 * Implements hook_xcommerce_body_classes_alter()
 */
function xdruple_invoice_xcommerce_body_classes_alter(&$classes, $path) {
  if ($path == 'user/%/invoices/%') {
    $classes[] = 'page-user-invoice';
  }
}

/**
 * Implements hook_menu_get_item_alter()
 */
function xdruple_invoice_menu_get_item_alter(&$router_item) {
  if ($router_item['path'] == 'user/%/invoices/%') {
    $router_item['tab_parent'] = 'user/%';
    $router_item['tab_root']   = 'user/%';
    $router_item['type']       = "132";
    $router_item['context']    = 1;
  }
}

/**
 * Implements hook_rescued_register_clients_resources_alter().
 */
function xdruple_invoice_rescued_register_clients_resources_alter(&$rescued_clients_url_resources) {
  if (!in_array('SalesOrder', $rescued_clients_url_resources['xtuple'])) {
    $rescued_clients_url_resources['xtuple'][] = 'SalesOrder';
  }
  if (!in_array('SalesOrderListItem', $rescued_clients_url_resources['xtuple'])) {
    $rescued_clients_url_resources['xtuple'][] = 'SalesOrderListItem';
  }
  if (!in_array('Invoice', $rescued_clients_url_resources['xtuple'])) {
    $rescued_clients_url_resources['xtuple'][] = 'Invoice';
  }
  if (!in_array('InvoiceListItem', $rescued_clients_url_resources['xtuple'])) {
    $rescued_clients_url_resources['xtuple'][] = 'InvoiceListItem';
  }
  if (!in_array('XdShipment', $rescued_clients_url_resources['xtuple'])) {
    $rescued_clients_url_resources['xtuple'][] = 'XdShipment';
  }
  if (!in_array('RemitTo', $rescued_clients_url_resources['xtuple'])) {
    $rescued_clients_url_resources['xtuple'][] = 'RemitTo';
  }

  return $rescued_clients_url_resources;
}

/**
 * Implements hook_views_pre_execute().
 */
function xdruple_invoice_views_pre_execute($view) {
  if ($view->name === 'xd_invoices') {
    // Query on Customer.
    if (isset($_SESSION['rescued']['customer'])) {
      $view->query->query->propertyConditions[]              = array(
        'column'   => 'customer',
        'value'    => $_SESSION['rescued']['customer'],
        'operator' => '=',
      );
      $view->build_info['count_query']->propertyConditions[] = array(
        'column'   => 'customer',
        'value'    => $_SESSION['rescued']['customer'],
        'operator' => '=',
      );
    }

// TODO: We can't currently query on Ship To because the ORM doesn't expose it.
//     // Query on Ship To.
//     if (isset($_SESSION['rescued']['ship_to'])) {
//       $view->query->query->propertyConditions[] = array(
//         'column' => 'shiptoName',
//         'value' => $_SESSION['rescued']['ship_to'],
//         'operator' => '=',
//       );
//       $view->build_info['count_query']->propertyConditions[] = array(
//         'column' => 'shiptoName',
//         'value' => $_SESSION['rescued']['ship_to'],
//         'operator' => '=',
//       );
//     }
  }
}

/**
 * Implements hook_theme()
 */
function xdruple_invoice_theme() {
  $items = array();

  $items['invoice_page'] = array(
    'variables' => array(
      'invoice' => array(),
    ),
    'template'  => 'theme/invoice-page',
    'file'      => 'theme/theme.inc',
  );

  return $items;
}
