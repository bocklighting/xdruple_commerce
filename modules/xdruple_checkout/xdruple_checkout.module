<?php

/**
 * Implements hook_cpanel_alter()
 *
 * @param $form
 * @param $form_state
 */
function xdruple_checkout_cpanel_alter(&$form, &$form_state) {
  if (empty($form['xdruple_commerce_store_settings'])) {
    $form['xdruple_commerce_store_settings'] = array(
      '#type' => 'fieldset',
      '#title' => t('Store settings'),
      '#group' => 'system_settings',
    );
  }

  $form['xdruple_commerce_store_settings']['xdruple_checkout_message'] = array(
    '#type' => 'textarea',
    '#title' => t('Anonymous user checkout redirect login message'),
    '#description' => t('The message that should be displayed on the login page in the checkout process.'),
    '#default_value' => variable_get('xdruple_checkout_message', t('You need to be logged in to be able to checkout.')),
    '#rows' => 2,
  );
  $form['xdruple_commerce_store_settings']['xdruple_checkout_anonymous'] = array(
    '#type' => 'checkbox',
    '#title' => t('Continue without register'),
    '#description' => t('Allow anonymous checkout. This will also provide an Anonymous Checkout option as an alternative to logging in on the login form when a user has initiated the checkout process.'),
    '#default_value' => variable_get('xdruple_checkout_anonymous', FALSE),
  );

  $customers = xdruple_fields_get_customer_list();
  if (count($customers) > 0) {
    $form['xdruple_commerce_store_settings']['xdruple_checkout_guest_customer'] = array(
      '#type' => 'select',
      '#options' => $customers,
      '#default_value' => variable_get('xdruple_checkout_guest_customer', '- None -'),
      '#empty_option' => '- None -',
      '#title' => t('Guest Customer'),
      '#description' => t('Select the Customer to use for guest checkout orders and/or anonymous user price quotes. All anonymous guest checkout orders will be created under this Customer in xTuple.'),
      '#required' => TRUE,
    );

    // The xTuple API only returns 100 results by default. If there are more than 98 customers, switch to a text field.
    if (count($customers) > 98) {
      $form['xdruple_commerce_store_settings']['xdruple_checkout_guest_customer']['#type'] = 'textfield';
      $form['xdruple_commerce_store_settings']['xdruple_checkout_guest_customer']['#default_value'] = variable_get('xdruple_checkout_guest_customer', NULL);
      $form['xdruple_commerce_store_settings']['xdruple_checkout_guest_customer']['#description'] =
        t('Enter the Customer Number of the Customer to use for all guest checkout orders. All anonymous guest checkout orders will be created under this Customer in xTuple.');
      unset($form['xdruple_commerce_store_settings']['xdruple_checkout_guest_customer']['#options']);
      unset($form['xdruple_commerce_store_settings']['xdruple_checkout_guest_customer']['#empty_option']);
    }
  }
  $form['xdruple_commerce_store_settings']['xdruple_checkout_use_guest_customer_price_schedule'] = array(
    '#type' => 'checkbox',
    '#title' => t("Use Guest Customer's price schedule for anonymous users"),
    '#description' => t('When checked, anonymous users will not see the Item List Price. Instead a price quote will be fetched and whatever pricing schedule the Guest Customer above is assigned to will adjust prices accordingly.'),
    '#default_value' => variable_get('xdruple_checkout_use_guest_customer_price_schedule', FALSE),
  );

  if (variable_get('user_email_verification', TRUE)) {
    $form['xdruple_commerce_store_settings']['xdruple_checkout_reset_password_message'] = array(
      '#type' => 'textarea',
      '#title' => t('Reset password checkout redirect message'),
      '#description' => t('The message that should be displayed on the reset password page for new accounts during the checkout process. When an anonymous users checks out and chooses to create a new account, they will be sent a one time login link to their email address. After clicking on it, they will be sent to the Reset Password page to create a password. This message will display on that page so they know they can continue their order after setting a password.'),
      '#default_value' => variable_get('xdruple_checkout_reset_password_message', t('Enter and save a new password and then you can continue with the checkout process.')),
      '#rows' => 2,
    );
  }

  $form['xdruple_commerce_store_settings']['xdruple_checkout_manager_order_confirm_emails'] = array(
    '#type' => 'textfield',
    '#size' => 60,
    '#title' => t('Manager order confirmation emails'),
    '#description' => t('A comma separated list of email addresses that should receive order confirmations. e.g. johndoe@example.com,janedoe@example.com'),
    '#default_value' => variable_get('xdruple_checkout_manager_order_confirm_emails', NULL),
  );
}

/**
 * Implements hook_default_rules_configuration_alter()
 *
 * @param $configs
 */
function xdruple_checkout_default_rules_configuration_alter(&$configs) {
  // Disable Commerce checkout default rules we do not need.
  if (!empty($configs['commerce_checkout_order_convert'])) {
    $configs['commerce_checkout_order_convert']->active = FALSE;
  }
  if (!empty($configs['commerce_checkout_new_account']->active)) {
    $configs['commerce_checkout_new_account']->active = FALSE;
  }
}

/**
 * Implements hook_commerce_checkout_router().
 *
 * @param $order
 * @param $checkout_page
 */
function xdruple_checkout_commerce_checkout_router($order, $checkout_page) {
  // Get the id of the first and last checkout page
  $checkout_pages = commerce_checkout_pages();
  $first_checkout_page = key($checkout_pages);
  end($checkout_pages);
  $last_checkout_page = key($checkout_pages);

  // Check if the user's shopping cart order exists with something in the cart
  if (commerce_cart_order_load() && xdruple_checkout_items_in_cart()) {
    if (($checkout_page['page_id'] == $first_checkout_page)) {
      if (user_is_anonymous() && empty($_SESSION['xdruple_checkout_bypass'])) {
        $_SESSION['xdruple_checkout_anonymous'] = TRUE;
        $checkout_message = variable_get('xdruple_checkout_message', t('You need to be logged in to be able to checkout.'));

        if (!empty($checkout_message)) {
          drupal_set_message($checkout_message);
        }

        drupal_goto('user/login');
      }
    }
  }
  elseif ($checkout_page['page_id'] == $last_checkout_page) {
    unset($_SESSION['xdruple_checkout_bypass']);
  }
}

/**
 * Implements hook_commerce_checkout_pane_info_alter().
 *
 * @param $checkout_panes
 */
function xdruple_checkout_commerce_checkout_pane_info_alter(&$checkout_panes) {
  if (user_is_anonymous()) {
    $checkout_panes['account']['page'] = 'disabled';
    $checkout_panes['account']['enabled'] = FALSE;
  }
}

/**
 * Implements hook_commerce_checkout_complete().
 *
 * @param $order
 */
function xdruple_checkout_commerce_checkout_complete($order) {
  global $user;

  /** @var stdClass $order_wrapper */
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);

  /** @var \Xtuple\Rescued\Controller\AbstractEntity $customer */
  $customer = entity_load_single("xtuple_xdcustomer", $order_wrapper->customer->value()->identifier());

  /** @var \Xtuple\REST\Entity\XdContact\XdContact $billing_contact */
  $billing_contact = $order_wrapper->commerce_customer_billing->contact->value();

  /** @var \Xtuple\REST\Entity\XdContact\XdContact $shipping_contact */
  $shipping_contact = $order_wrapper->commerce_customer_shipping->contact->value();

  $po_number = property_exists($order, 'xd_order_po_number') ? $order_wrapper->xd_order_po_number->value() : '';
  $order_notes = '';
  if (property_exists($order, 'xd_order_notes')) {
    $notes = $order_wrapper->xd_order_notes->value();
    if (!empty($notes)) {
      $order_notes = $notes['safe_value'];
    }
  }
  $default_shipto = NULL;

  foreach ($customer->get("shiptos") as $shipto) {
    if ($shipto['isDefault']) {
      $default_shipto = $shipto['isDefault'];
    }
  }
  /** @var \Xtuple\Rescued\Controller\AbstractEntity $shipto */
  $shipto = NULL;

  $sales_order = entity_create("xtuple_salesorder", array(
    "customer" => $customer->identifier(),
    "customerPurchaseOrderNumber" => $po_number,
    "orderDate" => date("Y-m-d"),
    "terms" => !empty($order->data['xdruple_terms']) ? $order->data['xdruple_terms'] : NULL,
    "salesRep" => $shipto ? $shipto->get("salesRep") : $customer->get("salesRep"),
    "commission" => $shipto ? $shipto->get("commission") : $customer->get("commission"),
    "taxZone" => $shipto ? $shipto->get("taxZone") : $customer->get("taxZone"),
    "site" => $customer->get("preferredSite"),
    "saleType" => "ECOMMERCE",
    "status" => \Xtuple\REST\Entity\SalesOrder\SalesOrderStatus::$open,

    "billtoName" => $billing_contact->value()->getName()->getFirst() . " " . $billing_contact->value()->getName()->getLast(),
    "billtoAddress1" => $billing_contact->value()->getAddress()->getThoroughfare(),
    "billtoAddress2" => $billing_contact->value()->getAddress()->getPremise(),
    "billtoAddress3" => $billing_contact->value()->getAddress()->getSubPremise(),
    "billtoCity" => $billing_contact->value()->getAddress()->getLocality(),
    "billtoState" => $billing_contact->value()->getAddress()->getAdministrativeArea(),
    "billtoCountry" => $billing_contact->value()->getAddress()->getCountry(),
    "billtoPostalCode" => $billing_contact->value()->getAddress()->getPostalCode(),
    "billtoContact" => $billing_contact->id(),
    "billtoContactHonorific" => $billing_contact->value()->getName()->getHonorific(),
    "billtoContactFirstName" => $billing_contact->value()->getName()->getFirst(),
    "billtoContactMiddleName" => $billing_contact->value()->getName()->getMiddle(),
    "billtoContactLastName" => $billing_contact->value()->getName()->getLast(),
    "billtoContactSuffix" => $billing_contact->value()->getName()->getTitle(),
    "billtoContactPhone" => $billing_contact->value()->getPhone(),
    "billtoContactTitle" => $billing_contact->value()->getJobTitle(),
    "billtoContactFax" => $billing_contact->value()->getFax(),
    "billtoContactEmail" => $billing_contact->value()->getEmail(),

    "shipto" => $shipto ? $shipto->identifier() : NULL,
    "shiptoName" => $shipto ? $shipto->get("name") : "",

//    "shiptoName" => $shipping_contact->value()->getName()->getFirst() . " " . $shipping_contact->value()->getName()->getLast(),
    "shiptoAddress1" => $shipping_contact->value()->getAddress()->getThoroughfare(),
    "shiptoAddress2" => $shipping_contact->value()->getAddress()->getPremise(),
    "shiptoAddress3" => $shipping_contact->value()->getAddress()->getSubPremise(),
    "shiptoCity" => $shipping_contact->value()->getAddress()->getLocality(),
    "shiptoState" => $shipping_contact->value()->getAddress()->getAdministrativeArea(),
    "shiptoCountry" => $shipping_contact->value()->getAddress()->getCountry(),
    "shiptoPostalCode" => $shipping_contact->value()->getAddress()->getPostalCode(),
    "shiptoContact" => $shipping_contact->id(),
    "shiptoContactHonorific" => $shipping_contact->value()->getName()->getHonorific(),
    "shiptoContactFirstName" => $shipping_contact->value()->getName()->getFirst(),
    "shiptoContactMiddleName" => $shipping_contact->value()->getName()->getMiddle(),
    "shiptoContactLastName" => $shipping_contact->value()->getName()->getLast(),
    "shiptoContactSuffix" => $shipping_contact->value()->getName()->getTitle(),
    "shiptoContactPhone" => $shipping_contact->value()->getPhone(),
    "shiptoContactTitle" => $shipping_contact->value()->getJobTitle(),
    "shiptoContactFax" => $shipping_contact->value()->getFax(),
    "shiptoContactEmail" => $shipping_contact->value()->getEmail(),

    "orderNotes" => $order_notes,
    "shipNotes" => $shipto ? $shipto->get("notes") : "",
    "shipVia" => $shipto ? $shipto->get("shipVia") : $customer->get("shipVia"),
    "currency" => $customer->get("currency"),
    "calculateFreight" => TRUE,
    "shipZone" => $shipto ? $shipto->get("shipZone") : NULL,
    "shipCharge" => $shipto ? $shipto->get("shipCharge") : $customer->get("shipCharge"),
    "wasQuote" => FALSE,
  ));


  /** @var Xtuple\Xdruple\Session\RescuedSession $session */
  $session = extensions_get_session();
  foreach ($order_wrapper->commerce_line_items->getIterator() as $delta => $line) {
    $property_info = $line->getPropertyInfo();
    if (isset($property_info['commerce_product'])) {
      // Set the line defaults.
      $sales_order->lineItems[$delta]['scheduleDate'] = xdruple_rescued_scheduled_date('tomorrow');
      $sales_order->lineItems[$delta]['firm'] = FALSE;
      $sales_order->lineItems[$delta]['site'] = $session->getRescued('site', $customer->preferredSite);
      $sales_order->lineItems[$delta]['taxType'] = 'Taxable';

      // We use the inventoryUnit for everything. See: xdruple_commerce_get_customer_line_item_price()
      // Set the line details.
      $sales_order->lineItems[$delta]['quantityUnitRatio'] = 1;
      $sales_order->lineItems[$delta]['item'] = $line->line_item_label->value();
      $sales_order->lineItems[$delta]['lineNumber'] = $delta + 1;
      $sales_order->lineItems[$delta]['subNumber'] = 0;
      $sales_order->lineItems[$delta]['quantityUnit'] = $line->commerce_product->inventoryUnit->value();
      $sales_order->lineItems[$delta]['priceUnit'] = $line->commerce_product->inventoryUnit->value();
      $sales_order->lineItems[$delta]['priceUnitRatio'] = 1;
      $sales_order->lineItems[$delta]['quantity'] = $line->quantity->value();
      $sales_order->lineItems[$delta]['customerPrice'] = ($line->commerce_unit_price->amount->value() / 100);
      $sales_order->lineItems[$delta]['price'] = ($line->commerce_unit_price->amount->value() / 100);
    }
    elseif (isset($property_info['commerce_shipping_service'])) {
      $sales_order->freight = ($line->commerce_unit_price->amount->value() / 100);
      $sales_order->calculateFreight = FALSE;
      $sales_order->shipVia = xdruple_shipping_map_ship_via($line->line_item_label->value());
    }
    else {
      // TODO - Handle tax lines.
    }
  }

  // Set flag to finalise payment.
  if (module_exists('xdruple_authnet')
    && isset($order->data['xdruple_auth_aim_trans_id'], $order->data['xdruple_auth_aim_payment_id'], $order->data['xdruple_auth_aim_amount'])
    && !empty($order->data['xdruple_auth_aim_trans_id'])
    && !empty($order->data['xdruple_auth_aim_payment_id'])
    && !empty($order->data['xdruple_auth_aim_amount'])
  ) {
    $finalize_auth_aim_order_payment = TRUE;
  }
  else {
    $finalize_auth_aim_order_payment = FALSE;
  }

  // Save the Sales Order.
  try {
    // We have to submit the order as the "admin" user because it has "MaintainSalesOrders" privilege.
    // TODO: We may want to handle this on the xTuple side so we don't have to switch the active user like this.
    if (!user_access('administer rescued entities', $user)) {
      unset($_SESSION['access_token']);
      unset($_SESSION['oauth_user']);
      $cached_user = $session->getRescued('user');
      $session->setRescued('user', 'admin');
      $sales_order->save();

      // Update the 'xtuple_creditcardpayment' with the final order number and
      // insert the matching 'xtuple_salesorderpayment' as the 'admin' user.
      if ($finalize_auth_aim_order_payment) {
        _xdruple_authnet_finalize_auth_aim_order_payment($order, $sales_order);
      }

      unset($_SESSION['access_token']);
      unset($_SESSION['oauth_user']);
      $session->setRescued('user', $cached_user);
    }
    else {
      // For admin users, we can save directly with their OAuth token.
      $sales_order->save();

      // Update the 'xtuple_creditcardpayment' with the final order number and
      // insert the matching 'xtuple_salesorderpayment' as the 'admin' user.
      if ($finalize_auth_aim_order_payment) {
        _xdruple_authnet_finalize_auth_aim_order_payment($order, $sales_order);
      }
    }

    // Set the Drupal Commerce order_number to match the auto-number
    // returned from xTuple after saving the order.
    $order_wrapper->order_number->set($sales_order->number);

    // Set email addresses to send order confirmation to.
    if (!empty($ship_to_emails)) {
      $order_wrapper->mail->set($ship_to_emails);
    }

    // Set email addresses for managers.
    $manager_emails = variable_get('xdruple_checkout_manager_order_confirm_emails', NULL);
    if (!empty($manager_emails)) {
      $confirm_emails = $order_wrapper->mail->value();
      $confirm_emails = $confirm_emails . ',' . str_replace(' ', '', $manager_emails);
      $order_wrapper->mail->set($confirm_emails);
    }

    $order_wrapper->save();
  } catch (Exception $e) {
    // Use try/catch to make sure and reset the user even if there is an error.
    if (!user_access('administer rescued entities', $user)) {
      unset($_SESSION['access_token']);
      unset($_SESSION['oauth_user']);
      $session->setRescued('user', $cached_user);
    }

    // TODO: Reset the order status?
    // This is a good question for Commerce Guys.
    drupal_set_message(t('Order Submit failed. Message = %message', array(
      '%message' => $e->getMessage()
    )), 'error');
  }
}

/**
 * Implements hook_form_alter().
 *
 * @param $form
 * @param $form_state
 * @param $form_id
 */
function xdruple_checkout_form_alter(&$form, &$form_state, $form_id) {
  if (in_array($form_id, array('user_login', 'user_login_block', 'user_profile_form', 'user_pass_reset'))) {
    _xdruple_checkout_alter_user_forms($form, $form_state, $form_id);
  }

  // For resetting the session variables for back to cart checkout button.
  if (strpos($form_id, 'commerce_checkout_form_') === 0 && !empty($form['buttons']['cancel'])) {
    $form['buttons']['cancel']['#submit'][] = 'xdruple_checkout_form_cancel_submit';
  }
}

/**
 * Private helper function to do hook_form_alter() to user forms.
 *
 * @param $form
 * @param $form_state
 * @param $form_id
 */
function _xdruple_checkout_alter_user_forms(&$form, &$form_state, $form_id) {
  $checkout_anonymous = variable_get('xdruple_checkout_anonymous', FALSE);

  // Check if user has an active cart order.
  if ($checkout_anonymous && $order = commerce_cart_order_load()) {
    // Check if there's anything in the cart and if user has not yet selected checkout method.
    if (xdruple_checkout_items_in_cart()
      && empty($_SESSION['xdruple_checkout_bypass'])
      && !empty($_SESSION['xdruple_checkout_anonymous'])
    ) {
      if (in_array($form_id, array('user_login', 'user_login_block', 'user_profile_form'))) {
        // Append the checkout redirect function on user's forms.
        $form['#submit'][] = 'xdruple_checkout_anonymous_submit';
        unset($form['#action']);

        // Anonymous checkout button.
        if (variable_get('xdruple_checkout_anonymous', FALSE)) {
          $form_state['#order'] = $order;
          $form['actions']['continue_button'] = array(
            '#name' => 'continue_button',
            '#type' => 'submit',
            '#value' => 'Checkout without an account',
            '#limit_validation_errors' => array(),
            '#submit' => array('xdruple_checkout_anonymous_continue_checkout'),
            '#states' => array(
              'visible' => array(
                ':input[name="have_pass"]' => array('value' => 0),
              ),
            ),
          );
          // Anonymous checkout as alternative to login form.
          $form['have_pass'] = array(
            '#type' => 'radios',
            '#title' => t('Do you have an account?'),
            '#description' => t('Choose %yes to login, %no to checkout as a guest or you can ', array(
                '%yes' => t('Yes'),
                '%no' => t('No')
              )) . l(t('create a new account'), 'user/register') . '.',
            '#options' => array(0 => t('Yes'), 1 => t('No')),
            '#weight' => -10,
            '#default_value' => 0,
          );
          $form['pass']['#states'] = array(
            'visible' => array(
              ':input[name="have_pass"]' => array('value' => 0),
            ),
          );
          $form['actions']['submit']['#states'] = array(
            'visible' => array(
              ':input[name="have_pass"]' => array('value' => 0),
            ),
          );
          //$form['pass']['#weight'] = 10;
          $form['actions']['continue_button']['#value'] = t('Checkout without an account');
          $form['actions']['continue_button']['#states'] = array(
            'visible' => array(
              ':input[name="have_pass"]' => array('value' => 1),
            ),
          );

          // Use the username as order email.
          // Email validation for the username form element
          $form['name']['#title'] = t('Email');
          $form['actions']['continue_button']['#limit_validation_errors'] = array(array('name'));
          $form['actions']['continue_button']['#validate'][] = 'xdruple_checkout_username_as_order_email_form_validate';
        }
      }
      elseif ($form_id == 'user_pass_reset' && !empty($form['actions'])) {
        // Provide the checkout as an alternative to the new account reset password process.
        // Message (help text) for the "Continue with checkout" button.
        $reset_password_message = variable_get('xdruple_checkout_reset_password_message', t('Enter and save a new password and then you can continue with the checkout process.'));

        if (!empty($reset_password_message)) {
          $form['actions']['checkout_message']['#markup'] = '<p>' . $reset_password_message . '</p>';
        }

        // "Continue with checkout" submit button.
        $form['actions']['checkout'] = array(
          '#type' => 'submit',
          '#value' => t('Continue with checkout'),
        );

        // Append the checkout redirect function on user's forms.
        $form['#submit'][] = 'xdruple_checkout_anonymous_submit';

        // Unset the action, use submit form function(s) instead.
        unset($form['#action']);
      }
    }
  }
}

/**
 * Submit callback for the user forms that will perform the redirection.
 */
function xdruple_checkout_anonymous_submit($form, &$form_state) {
  // Because the user in the order may have been updated (from uid 0 to the real
  // uid for example), clear static cache before trying to get the order.
  drupal_static_reset('commerce_cart_order_id');

  if (!empty($_SESSION['xdruple_checkout_anonymous'])) {
    // One time login link (reset password) for creating new account.
    if ($form['#form_id'] == 'user_pass_reset') {
      // Login for the new account to continue
      // with the checkout process.
      // @see user_pass_reset()
      if ($form_state['clicked_button']['#id'] == 'edit-checkout') {
        global $user;
        $users = user_load_multiple(array($form_state['build_info']['args'][0]), array('status' => '1'));
        $user = reset($users);
        $GLOBALS['user'] = $user;
        // User login with user_login_finalize().
        user_login_finalize();
        // Let the user's password be changed without the current password check.
        $token = drupal_random_key();
        $_SESSION['pass_reset_' . $GLOBALS['user']->uid] = $token;
      }
      // Continue the reset password process.
      else {
        drupal_goto('user/reset/' . implode('/', $form_state['build_info']['args']) . '/login');
      }
    }
    $order_id = commerce_cart_order_id($GLOBALS['user']->uid);
    if (user_is_logged_in() && $order_id) {
      unset($_SESSION['xdruple_checkout_anonymous']);
      $form_state['redirect'] = 'checkout/' . $order_id;
    }
  }
}

/**
 * Form validation handler for login form for using username as order email.
 */
function xdruple_checkout_username_as_order_email_form_validate($form, &$form_state) {
  $name = trim($form_state['values']['name']);
  form_set_value($form['name'], $name, $form_state);

  // Validate the e-mail address, and check if it is taken by an existing user.
  if ($error = user_validate_mail($form_state['values']['email'])) {
    form_set_error('name', $error);
  }
  else {
    $mail_taken = (bool) db_select('users')
      ->fields('users', array('uid'))
      ->condition('uid', $GLOBALS['user']->uid, '<>')
      ->condition('mail', db_like($form_state['values']['email']), 'LIKE')
      ->range(0, 1)
      ->execute()
      ->fetchField();
    if ($mail_taken) {
      // Format error message dependent on whether the user is logged in or not.
      // TODO: I'm not sure how this could be called by a user that is logged in.
      if ($GLOBALS['user']->uid) {
        form_set_error('name', t('The e-mail address %email is already taken.', array('%email' => $form_state['values']['email'])));
      }
      else {
        form_set_error('name', t('The e-mail address %email is already registered. <a href="@password">Have you forgotten your password?</a>', array(
          '%email' => $form_state['values']['email'],
          '@password' => url('user/password')
        )));
      }
    }
  }
}

/**
 * Submit callback to allow an anonymous users to continue without logging in.
 */
function xdruple_checkout_anonymous_continue_checkout($form, &$form_state) {
  // If the user chooses to continue without an account, set this variable so user
  // is only redirected once per order (or once per session if the session expires first).
  $_SESSION['xdruple_checkout_bypass'] = TRUE;
  $order = $form_state['#order'];

  // Using the username as order email.
  $order->mail = $form_state['values']['name'];
  commerce_order_save($order);

  $form_state['redirect'] = 'checkout/';
}

/**
 * Submit callback for the reset the checkout to cart.
 */
function xdruple_checkout_form_cancel_submit($form, &$form_state) {
  if (!empty($_SESSION['xdruple_checkout_anonymous'])) {
    unset($_SESSION['xdruple_checkout_anonymous']);
  }
  if (!empty($_SESSION['xdruple_checkout_bypass'])) {
    unset($_SESSION['xdruple_checkout_bypass']);
  }
}

/**
 * Helper function to check if the cart contains any items.
 */
function xdruple_checkout_items_in_cart() {
  global $user;

  $cart = commerce_cart_order_load($user->uid);
  $line_items = count($cart->commerce_line_items) ? TRUE : FALSE;

  return $line_items;
}

/**
 * Implements hook_features_exclude()
 *
 * @return array
 */
function xdruple_checkout_features_exclude() {
  return array(
    'variable' => array(
      'xdruple_checkout_manager_order_confirm_emails',
      'xdruple_checkout_message',
      'xdruple_checkout_reset_password_message',
    ),
  );
}
